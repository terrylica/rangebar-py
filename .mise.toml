[env]
# Existing GitHub tokens (preserve)
GH_TOKEN = "{{ read_file(path=env.HOME ~ '/.claude/.secrets/gh-token-terrylica') | trim }}"
GITHUB_TOKEN = "{{ read_file(path=env.HOME ~ '/.claude/.secrets/gh-token-terrylica') | trim }}"

# Benchmark configuration
BENCH_DATA_DIR = "{{ env.PWD }}/bench-data"
PROFILE_DATA_DIR = "{{ env.PWD }}/profile-data"

# =============================================================================
# Linux Build Configuration (SSH-based remote build)
# =============================================================================
LINUX_BUILD_HOST = "bigblack"
LINUX_BUILD_USER = "tca"
LINUX_BUILD_DIR = "/tmp/rangebar-py-build"
LINUX_MATURIN_PROFILE = "wheel"
LINUX_MATURIN_COMPAT = "manylinux_2_17"
LINUX_MIN_DISK_GB = "5"
LINUX_MIN_RUST_VERSION = "1.90"

# =============================================================================
# Tools - managed by mise (NOT separate cargo install)
# =============================================================================

[tools]
python = "3.11"
rust = "1.90"
node = "22"          # Required for semantic-release
uv = "latest"        # Required for publish workflow
# Cargo tools installed as mise plugins
"cargo:cargo-nextest" = "latest"
"cargo:cargo-deny" = "latest"
"cargo:cargo-outdated" = "latest"
"cargo:flamegraph" = "0.6"
"cargo:maturin" = "latest"

# =============================================================================
# Development Tasks (from Makefile)
# =============================================================================

[tasks.fmt]
description = "Format code with cargo fmt"
run = "cargo fmt --all"

[tasks.lint]
description = "Run clippy linting"
run = "cargo clippy --all-targets --all-features"

[tasks.test]
description = "Run Rust tests with cargo nextest (excludes PyO3 root crate)"
run = "cargo nextest run --workspace --exclude rangebar-py"

[tasks.test-py]
description = "Run Python tests"
run = "pytest tests/ -v"

[tasks.deny]
description = "Run cargo deny security checks"
run = "cargo deny check"

[tasks.check]
description = "Run all quality checks (fmt + test)"
depends = ["fmt", "test"]

[tasks.check-full]
description = "Full quality checks including lint and deny"
depends = ["fmt", "lint", "test", "deny"]

[tasks.build]
description = "Build Python extension (development)"
run = "maturin develop"

[tasks.build-release]
description = "Build in release mode"
run = "cargo build --release"

[tasks.clean]
description = "Clean build artifacts"
run = "cargo clean && rm -rf dist/ build/ *.egg-info"

[tasks.docs]
description = "Generate documentation"
run = "cargo doc --open --all-features"

[tasks.dev]
description = "Quick development cycle (fmt + test)"
depends = ["fmt", "test"]

# =============================================================================
# Benchmarking Tasks (REPLACES benchmark_runner.sh)
# =============================================================================

[tasks."bench:run"]
description = "Run performance benchmarks"
run = "cargo bench --bench rangebar_bench"

[tasks."bench:quick"]
description = "Run quick benchmarks (reduced iterations)"
run = "cargo bench --bench rangebar_bench -- --quick"

[tasks."bench:baseline"]
description = "Create performance baseline"
run = """
mkdir -p $BENCH_DATA_DIR
cargo bench --bench rangebar_bench -- --save-baseline main
echo "Baseline saved to $BENCH_DATA_DIR/main"
"""

[tasks."bench:compare"]
description = "Compare current performance with baseline"
run = "cargo bench --bench rangebar_bench -- --baseline main"

[tasks."bench:validate"]
description = "Validate performance targets (1M ticks < 100ms)"
run = """
echo "Running performance validation..."
cargo bench --bench rangebar_bench -- --quick 2>&1 | tee /tmp/bench_output.txt
if grep -q "1M.*time:.*[0-9][0-9][0-9]\\.[0-9]* ms" /tmp/bench_output.txt; then
  echo "FAIL: 1M ticks benchmark exceeds 100ms target"
  exit 1
fi
echo "PASS: Performance targets met"
"""

# =============================================================================
# Profiling Tasks (REPLACES profiling_tools.sh for simple cases)
# =============================================================================

[tasks."prof:flamegraph"]
description = "Generate CPU flamegraph"
run = """
mkdir -p $PROFILE_DATA_DIR
cargo flamegraph --bench rangebar_bench -o $PROFILE_DATA_DIR/flamegraph-$(date +%Y%m%d-%H%M%S).svg
echo "Flamegraph saved to $PROFILE_DATA_DIR/"
"""

[tasks."prof:build-release"]
description = "Build with profiling symbols"
run = "CARGO_PROFILE_RELEASE_DEBUG=true cargo build --release"

# Complex profiling (platform-specific) kept in script
[tasks."prof:full"]
description = "Comprehensive profiling suite (uses script for platform detection)"
run = "./scripts/profiling_tools.sh full"

# =============================================================================
# Dependency Management Tasks (PARTIAL - complex logic in script)
# =============================================================================

[tasks."deps:check"]
description = "Check for outdated dependencies"
run = "cargo outdated -R --color always"

[tasks."deps:security"]
description = "Run security audit on dependencies"
run = "cargo deny check advisories && cargo deny check licenses"

[tasks."deps:tree"]
description = "Show dependency tree (depth 1)"
run = "cargo tree --depth 1 | grep -E '^[a-z]'"

[tasks."deps:update"]
description = "Update dependencies (simple - no rollback)"
run = """
cargo update
cargo nextest run --no-fail-fast
echo "Dependencies updated and tests passed"
"""

# Complex update with rollback kept in script
[tasks."deps:update-safe"]
description = "Update dependencies with backup/rollback (uses script)"
run = "./scripts/dependency_monitor.sh auto"

# =============================================================================
# Production Validation Tasks (REPLACES production_validation.sh)
# =============================================================================

[tasks."validate:security"]
description = "Validate no privilege escalation in scripts"
run = """
if grep -r 'sudo' scripts/*.sh 2>/dev/null; then
  echo "FAIL: Found sudo usage in scripts"
  exit 1
fi
echo "PASS: No privilege escalation detected"
"""

[tasks."validate:injection"]
description = "Validate command injection prevention"
run = """
if grep -E '\\$\\(.*\\$[A-Z]' scripts/*.sh 2>/dev/null; then
  echo "WARN: Potential command injection pattern found"
fi
echo "PASS: Command injection check complete"
"""

[tasks."validate:memory"]
description = "Validate memory efficiency for high-volume months (prevents OOM regressions)"
run = "python scripts/validate_memory_efficiency.py"

[tasks."validate:all"]
description = "Run all production validation checks"
depends = ["validate:security", "validate:injection", "validate:memory"]

# =============================================================================
# Release Tasks
# =============================================================================

[tasks.release]
description = "Build all release wheels"
run = "./scripts/build-release.sh"

[tasks.publish]
description = "Publish wheels to PyPI"
run = "./scripts/publish-wheels.sh"

[tasks."release:local"]
description = "Build local wheel only (macOS ARM64)"
run = "maturin build --release --profile wheel"

[tasks."release:sdist"]
description = "Build source distribution"
run = "maturin sdist"

# =============================================================================
# Platform-Specific Build Tasks (Issue #17)
# =============================================================================

[tasks."release:macos-arm64"]
description = "Build macOS ARM64 wheel (native)"
run = "maturin build --profile wheel"

[tasks."release:linux-preflight"]
description = "Verify Linux build host availability"
run = """
echo "=== Linux Build Preflight ==="
if ! ssh -o ConnectTimeout=5 -o BatchMode=yes "$LINUX_BUILD_USER@$LINUX_BUILD_HOST" "echo connected" >/dev/null 2>&1; then
    echo "FAIL: Cannot connect to $LINUX_BUILD_USER@$LINUX_BUILD_HOST"
    exit 1
fi
echo "OK: SSH connectivity verified"

REMOTE_RUST=$(ssh "$LINUX_BUILD_USER@$LINUX_BUILD_HOST" "~/.cargo/bin/rustc --version 2>/dev/null | cut -d' ' -f2" || echo "not found")
echo "OK: Remote Rust version: $REMOTE_RUST"
"""

[tasks."release:linux"]
description = "Build Linux x86_64 wheel on remote host (Docker manylinux)"
depends = ["release:linux-preflight"]
run = """
echo "=== Building Linux x86_64 Wheel (Docker manylinux) ==="
PROJECT_DIR="$(pwd)"
REMOTE_DIR="${LINUX_BUILD_DIR}-$$"

cleanup() { ssh "$LINUX_BUILD_USER@$LINUX_BUILD_HOST" "rm -rf $REMOTE_DIR" 2>/dev/null || true; }
trap cleanup EXIT

ssh "$LINUX_BUILD_USER@$LINUX_BUILD_HOST" "mkdir -p $REMOTE_DIR"

rsync -az --delete \
    --exclude 'target/' --exclude 'dist/' --exclude '.git/' \
    --exclude '__pycache__/' --exclude '*.egg-info/' --exclude 'node_modules/' \
    "$PROJECT_DIR/" "$LINUX_BUILD_USER@$LINUX_BUILD_HOST:$REMOTE_DIR/"

# Build using manylinux Docker container for glibc compatibility
ssh "$LINUX_BUILD_USER@$LINUX_BUILD_HOST" 'cd '"$REMOTE_DIR"' && docker run --rm -v $(pwd):/io -w /io quay.io/pypa/manylinux2014_x86_64 bash -c "yum install -y openssl-devel perl-IPC-Cmd && curl --proto =https --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y && source ~/.cargo/env && /opt/python/cp311-cp311/bin/pip install maturin && /opt/python/cp311-cp311/bin/maturin build --profile wheel --compatibility manylinux2014 -i /opt/python/cp311-cp311/bin/python"'

mkdir -p dist/
scp "$LINUX_BUILD_USER@$LINUX_BUILD_HOST:$REMOTE_DIR/target/wheels/*manylinux*.whl" dist/
echo "OK: Linux wheel built"
"""

# =============================================================================
# 4-Phase Workflow Tasks
# =============================================================================

[tasks."release:preflight"]
description = "Validate release prerequisites (Phase 1)"
run = """
echo "=== PREFLIGHT ==="
git update-index --refresh -q || true

if [ -n "$(git status --porcelain)" ]; then
    echo "FAIL: Working directory not clean"
    git status --short
    exit 1
fi

BRANCH=$(git branch --show-current)
if [ "$BRANCH" != "main" ]; then
    echo "FAIL: Not on main branch (on: $BRANCH)"
    exit 1
fi

echo "OK: Preflight passed"
"""

[tasks."release:sync"]
description = "Synchronize with remote (Phase 2)"
depends = ["release:preflight"]
run = """
echo "=== SYNC ==="
git pull --rebase origin main || { echo "FAIL: Pull failed"; exit 1; }
git push origin main || { echo "FAIL: Push failed"; exit 1; }
echo "OK: Synced"
"""

[tasks."release:build-all"]
description = "Build all platform wheels (Phase 3)"
run = """
echo "=== BUILD ALL PLATFORMS ==="
mise run release:macos-arm64
mise run release:linux
echo "OK: All wheels built"
ls -la dist/*.whl 2>/dev/null || true
"""

[tasks."release:postflight"]
description = "Verify and publish (Phase 4)"
depends = ["smoke"]
run = """
echo "=== POSTFLIGHT ==="
WHEEL_COUNT=$(find dist/ -name "*.whl" 2>/dev/null | wc -l | tr -d ' ')
echo "Found $WHEEL_COUNT wheel(s)"
ls -la dist/*.whl 2>/dev/null || true
echo ""
echo "To publish: mise run publish"
"""

[tasks."release:version"]
description = "Bump version via semantic-release (requires npm install first)"
run = """
if [ ! -d node_modules ]; then
  echo "Installing npm dependencies..."
  npm install
fi
npm run release
"""

[tasks."release:full"]
description = "Full 4-phase release workflow"
run = """
echo "=== FULL RELEASE WORKFLOW ==="

echo ""
echo "=== Phase 1: PREFLIGHT ==="
mise run release:preflight

echo ""
echo "=== Phase 2: SYNC ==="
mise run release:sync

echo ""
echo "=== Phase 3: VERSION (semantic-release) ==="
mise run release:version

echo ""
echo "=== Phase 4: BUILD ==="
mise run release:build-all

echo ""
echo "=== Phase 5: POSTFLIGHT ==="
mise run release:postflight

echo ""
echo "=== COMPLETE ==="
echo "Run 'mise run publish' to publish to PyPI"
"""

# =============================================================================
# Smoke Test Tasks
# =============================================================================

[tasks."smoke:import"]
description = "Verify Python import works"
run = "python -c 'from rangebar import RangeBarProcessor; print(\"OK: import works\")'"

[tasks."smoke:process"]
description = "Verify basic processing works"
run = """
python -c '
from rangebar._core import PyRangeBarProcessor
proc = PyRangeBarProcessor(threshold_decimal_bps=250)
assert proc.threshold_decimal_bps == 250
bars = proc.process_trades([])
assert bars == []
print("OK: basic processing works")
'
"""

[tasks.smoke]
description = "Run all smoke tests"
depends = ["smoke:import", "smoke:process"]
