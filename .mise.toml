# =============================================================================
# rangebar-py mise configuration (Hub)
# =============================================================================
# This is the SSoT for environment variables and tools.
# Tasks are split into domain-specific files in .mise/tasks/
#
# Task files:
#   .mise/tasks/dev.toml      - fmt, lint, test, build
#   .mise/tasks/release.toml  - release workflow, platform builds
#   .mise/tasks/bench.toml    - benchmarking
#   .mise/tasks/prof.toml     - profiling
#   .mise/tasks/deps.toml     - dependency management
#   .mise/tasks/validate.toml - production validation
#   .mise/tasks/cache.toml    - ClickHouse cache
#   .mise/tasks/smoke.toml    - smoke tests
#   .mise/tasks/checksum.toml - checksum verification
#   .mise/tasks/diag.toml     - diagnostics
#   .mise/tasks/research.toml - research cache population
#   .mise/tasks/telemetry.toml - structured telemetry
#   .mise/tasks/recency.toml  - Layer 2 recency backfill (Issue #92)
#   .mise/tasks/deploy.toml   - Remote host deployment (bigblack)

[env]
# =============================================================================
# SSoT: Minimum Thresholds by Asset Class (Issue #62)
# =============================================================================
# Values are in decimal basis points (dbps): 1000 dbps = 1%
RANGEBAR_CRYPTO_MIN_THRESHOLD = "250"
RANGEBAR_FOREX_MIN_THRESHOLD = "50"
RANGEBAR_EQUITIES_MIN_THRESHOLD = "100"
RANGEBAR_UNKNOWN_MIN_THRESHOLD = "1"

# =============================================================================
# Per-Symbol Minimum Thresholds (Issue #89)
# =============================================================================
# SSoT: symbols.toml `min_threshold` field. These env vars are operational
# overrides only — threshold.py reads the registry first, then falls back here.
# Resolution: per-symbol env > symbols.toml min_threshold > asset-class env > fallback.
#
# Tier A: Meme coins with extreme price volatility
# SHIBUSDT: min 750 dbps (110K bars on pump day at 500 dbps — infeasible below 750).
RANGEBAR_MIN_THRESHOLD_SHIBUSDT = "750"
# WIFUSDT: dogwifhat meme coin — 40x price move in first weeks after 2024-03-05 listing.
#   No benchmark data yet but meme coin classification + extreme listing volatility
#   guarantees infeasibility below 1000 dbps. Hard floor: 1000 dbps.
RANGEBAR_MIN_THRESHOLD_WIFUSDT = "1000"
# PEPEUSDT: Pepe the Frog meme coin — micro-cent fractional token, ~200MB/month aggTrade
#   files. Extreme tick density makes sub-1000 dbps infeasible (same Tier A as SHIB/WIF).
RANGEBAR_MIN_THRESHOLD_PEPEUSDT = "1000"
# DOGEUSDT: 219,893 bars on 2021-01-28 pump day at 250 dbps (~110K bars at 500 dbps).
#   At 500 dbps the pump-day bar count is comparable to SHIB@500 (infeasible tier).
#   Floor is 500 here because DOGE@500 data is already populated on bigblack and
#   500 is workable outside extreme pump days. Revisit to raise to 1000 if benchmarks
#   show compute infeasibility at 500.
RANGEBAR_MIN_THRESHOLD_DOGEUSDT = "500"
#
# Tier B: Provisional 500 dbps floor pending benchmark (500-730 bars/day @250)
# Decision: start conservative at 500, benchmark full-feature compute time,
# lower back to 250 if per-year compute is acceptable. See Issue #89.
RANGEBAR_MIN_THRESHOLD_SOLUSDT = "500"
RANGEBAR_MIN_THRESHOLD_AVAXUSDT = "500"
RANGEBAR_MIN_THRESHOLD_NEARUSDT = "500"
RANGEBAR_MIN_THRESHOLD_UNIUSDT = "500"
RANGEBAR_MIN_THRESHOLD_LINKUSDT = "500"
RANGEBAR_MIN_THRESHOLD_XRPUSDT = "500"
RANGEBAR_MIN_THRESHOLD_ATOMUSDT = "500"
RANGEBAR_MIN_THRESHOLD_DOTUSDT = "500"
RANGEBAR_MIN_THRESHOLD_ADAUSDT = "500"
RANGEBAR_MIN_THRESHOLD_LTCUSDT = "500"
RANGEBAR_MIN_THRESHOLD_BCHUSDT = "500"
RANGEBAR_MIN_THRESHOLD_TRXUSDT = "500"
RANGEBAR_MIN_THRESHOLD_ZECUSDT = "500"
RANGEBAR_MIN_THRESHOLD_HBARUSDT = "500"
RANGEBAR_MIN_THRESHOLD_TONUSDT = "500"
# PAXGUSDT: gold-backed token, tracks XAU/USD, low volatility — no per-symbol floor.
#   Uses 250 dbps crypto class default. Override to lower (e.g. 100 dbps) if needed.

# =============================================================================
# SSoT: Microstructure Feature Defaults (Issue #68)
# =============================================================================
# When include_microstructure=True, these defaults are used unless overridden.
# INTER_BAR_LOOKBACK_COUNT: Trades in lookback window for inter-bar features.
#   - Recommended: 100-500 (200 is good balance of signal vs compute)
#   - Set to 0 to disable inter-bar features while keeping intra-bar
# INCLUDE_INTRA_BAR_FEATURES: Enable ITH + statistical features within bars.
#   - "true" enables 22 intra_* columns (ITH, complexity, statistical)
#   - "false" disables (use if you only need lookback_* features)
RANGEBAR_INTER_BAR_LOOKBACK_COUNT = "200"
RANGEBAR_INCLUDE_INTRA_BAR_FEATURES = "true"

# =============================================================================
# SSoT: Recency Backfill Adaptive Thresholds (Issue #92)
# =============================================================================
# Layer 2 adaptive polling loop self-tunes frequency based on gap size.
# Gap below FRESH → sleep 15 min. Gap above STALE → sleep 5 min.
# Gap above CRITICAL → sleep 2 min. Beyond CRITICAL → sleep 30s.
RANGEBAR_RECENCY_FRESH_THRESHOLD_MIN = "30"
RANGEBAR_RECENCY_STALE_THRESHOLD_MIN = "120"
RANGEBAR_RECENCY_CRITICAL_THRESHOLD_MIN = "1440"

# =============================================================================
# SSoT: Layer 3 Streaming Sidecar (Issue #91)
# =============================================================================
# Configuration for the live WebSocket → range bar → ClickHouse sidecar.
# Symbols: comma-separated list (e.g., "BTCUSDT,ETHUSDT").
# Thresholds: comma-separated dbps (e.g., "250,500,750,1000").
RANGEBAR_STREAMING_SYMBOLS = "AAVEUSDT,ADAUSDT,AVAXUSDT,BCHUSDT,BNBUSDT,BTCUSDT,DOGEUSDT,ETHUSDT,FILUSDT,LINKUSDT,LTCUSDT,NEARUSDT,SOLUSDT,SUIUSDT,UNIUSDT,WIFUSDT,WLDUSDT,XRPUSDT"
RANGEBAR_STREAMING_THRESHOLDS = "250,500,750,1000"
RANGEBAR_STREAMING_MICROSTRUCTURE = "true"
RANGEBAR_STREAMING_GAP_FILL = "true"
RANGEBAR_STREAMING_VERBOSE = "false"
RANGEBAR_STREAMING_TIMEOUT_MS = "5000"
# Issue #107: Watchdog detects half-open TCP via trade flow staleness.
# 300s (5 min) of zero trade increment → engine restart.
RANGEBAR_STREAMING_WATCHDOG_TIMEOUT_S = "600"
# Max engine restarts before sidecar exits (systemd restarts the process).
RANGEBAR_STREAMING_MAX_WATCHDOG_RESTARTS = "3"

# =============================================================================
# GitHub Account Isolation
# =============================================================================
GH_ACCOUNT = "terrylica"
GH_CONFIG_DIR = "{{ env.HOME }}/.config/gh/profiles/terrylica"
GH_TOKEN = "{{ read_file(path=env.HOME ~ '/.claude/.secrets/gh-token-terrylica') | trim }}"
GITHUB_TOKEN = "{{ read_file(path=env.HOME ~ '/.claude/.secrets/gh-token-terrylica') | trim }}"

# =============================================================================
# 1Password Configuration
# =============================================================================
OP_PYPI_ITEM = "zdc7ap2ixpqgtpq62xm2davi7e"
OP_PYPI_VAULT = "ggk4orq7rmcm7jinsb4ahygv7e"

# =============================================================================
# Telegram Notifications (@rangebarbot)
# =============================================================================
RANGEBAR_TELEGRAM_TOKEN = "{{ read_file(path=env.HOME ~ '/.claude/.secrets/rangebar-telegram-token') | trim }}"
RANGEBAR_TELEGRAM_CHAT_ID = "90417581"

# =============================================================================
# ClickHouse Cache Configuration
# =============================================================================
RANGEBAR_CH_HOSTS = "bigblack"
RANGEBAR_CH_PRIMARY = "bigblack"
RANGEBAR_MODE = "remote"

# =============================================================================
# Build Configuration
# =============================================================================
BENCH_DATA_DIR = "{{ env.PWD }}/bench-data"
PROFILE_DATA_DIR = "{{ env.PWD }}/profile-data"

# =============================================================================
# Linux Build Configuration
# =============================================================================
LINUX_BUILD_STRATEGY = "zig"  # "zig" or "remote"
LINUX_BUILD_HOST = "bigblack"
LINUX_BUILD_USER = "tca"
LINUX_BUILD_DIR = "/tmp/rangebar-py-build"
LINUX_MATURIN_PROFILE = "wheel"
LINUX_MATURIN_COMPAT = "manylinux_2_17"
LINUX_MIN_DISK_GB = "5"
LINUX_MIN_RUST_VERSION = "1.90"
BUILD_LOCK_DIR = "/tmp/rangebar-py-locks"

# =============================================================================
# Tools
# =============================================================================

[tools]
python = "3.13"
rust = "1.90"
node = "22"
uv = "latest"
zig = "0.13"
"cargo:cargo-nextest" = "latest"
"cargo:cargo-deny" = "latest"
"cargo:cargo-outdated" = "latest"
"cargo:flamegraph" = "0.6"
"cargo:maturin" = "latest"
"cargo:cargo-zigbuild" = "latest"

# =============================================================================
# Task Includes (Hub-and-Spoke)
# =============================================================================

[task_config]
includes = [
    ".mise/tasks/dev.toml",
    ".mise/tasks/release.toml",
    ".mise/tasks/release-crates.toml",
    ".mise/tasks/bench.toml",
    ".mise/tasks/prof.toml",
    ".mise/tasks/deps.toml",
    ".mise/tasks/validate.toml",
    ".mise/tasks/cache.toml",
    ".mise/tasks/smoke.toml",
    ".mise/tasks/checksum.toml",
    ".mise/tasks/diag.toml",
    ".mise/tasks/research.toml",
    ".mise/tasks/telemetry.toml",
    ".mise/tasks/recency.toml",
    ".mise/tasks/deploy.toml",
    ".mise/tasks/sketch.toml",
]
