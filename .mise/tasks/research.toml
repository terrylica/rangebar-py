# Research Cache Population Tasks (Issue #58)
# Sequential execution to avoid OOM on limited-memory hosts

["research:populate-symbol"]
description = "Populate cache for a single symbol (requires SYMBOL and THRESHOLD env vars)"
run = """
#!/usr/bin/env bash
set -e

uv run --python 3.13 python -c '
import os
import sys
import time
from datetime import UTC, datetime, timedelta

from rangebar import get_range_bars

SYMBOL = os.environ.get("SYMBOL")
if not SYMBOL:
    print("ERROR: SYMBOL env var required", flush=True)
    sys.exit(1)

START = os.environ.get("START", "2022-01-01")
END = os.environ.get("END", "2025-12-31")
THRESHOLD = int(os.environ.get("THRESHOLD", "250"))

def date_range_months(start_str, end_str):
    start = datetime.strptime(start_str, "%Y-%m-%d").replace(tzinfo=UTC)
    end = datetime.strptime(end_str, "%Y-%m-%d").replace(tzinfo=UTC)
    current = start
    while current < end:
        month_end = (current.replace(day=28) + timedelta(days=4)).replace(day=1) - timedelta(days=1)
        month_end = min(month_end, end)
        yield current.strftime("%Y-%m-%d"), month_end.strftime("%Y-%m-%d")
        current = month_end + timedelta(days=1)

print(f"Populating {SYMBOL} @ {THRESHOLD} dbps ({START} to {END})", flush=True)
total_bars = 0
for chunk_start, chunk_end in date_range_months(START, END):
    t0 = time.time()
    try:
        df = get_range_bars(SYMBOL, chunk_start, chunk_end, threshold_decimal_bps=THRESHOLD, use_cache=True, fetch_if_missing=True)
        elapsed = time.time() - t0
        total_bars += len(df)
        print(f"  {chunk_start}: {len(df):>6,} bars ({elapsed:>5.1f}s)", flush=True)
    except Exception as e:
        print(f"  {chunk_start}: ERROR - {e}", flush=True)
print(f"DONE: {total_bars:,} total bars", flush=True)
'
"""

["research:populate-all"]
description = "Populate cache for all symbols at 250 then 1000 dbps (fully sequential)"
run = """
#!/usr/bin/env bash
set -e

echo "=========================================="
echo "FULL CACHE POPULATION - 250 dbps then 1000 dbps"
echo "=========================================="
echo "Started: $(date)"

mise run research:populate-250
mise run research:populate-1000

echo ""
echo "=========================================="
echo "ALL POPULATION COMPLETE (250 + 1000 dbps)"
echo "Finished: $(date)"
echo "=========================================="
"""

["research:populate-250"]
description = "Populate 250 dbps cache for all symbols (sequential, OOM-safe)"
run = """
#!/usr/bin/env bash
set -e

echo "=== SEQUENTIAL CACHE POPULATION (250 dbps) ==="
echo "Started: $(date)"

SYMBOLS="BTCUSDT ETHUSDT BNBUSDT ADAUSDT AVAXUSDT DOTUSDT MATICUSDT NEARUSDT ATOMUSDT APTUSDT SUIUSDT LINKUSDT UNIUSDT AAVEUSDT DOGEUSDT SHIBUSDT PEPEUSDT FTMUSDT"

TOTAL=18
CURRENT=0

for SYMBOL in $SYMBOLS; do
    CURRENT=$((CURRENT + 1))
    echo ""
    echo "=========================================="
    echo "[$CURRENT/$TOTAL] $SYMBOL @ 250 dbps"
    echo "=========================================="
    SYMBOL=$SYMBOL THRESHOLD=250 mise run research:populate-symbol
    echo "Completed $SYMBOL. Sleeping 10s before next..."
    sleep 10
done

echo ""
echo "ALL $TOTAL SYMBOLS @ 250 dbps COMPLETE"
echo "Finished: $(date)"
"""

["research:populate-1000"]
description = "Populate 1000 dbps cache for all symbols (sequential, OOM-safe)"
run = """
#!/usr/bin/env bash
set -e

echo "=== SEQUENTIAL CACHE POPULATION (1000 dbps) ==="
echo "Started: $(date)"

SYMBOLS="BTCUSDT ETHUSDT BNBUSDT ADAUSDT AVAXUSDT DOTUSDT MATICUSDT NEARUSDT ATOMUSDT APTUSDT SUIUSDT LINKUSDT UNIUSDT AAVEUSDT DOGEUSDT SHIBUSDT PEPEUSDT FTMUSDT"

TOTAL=18
CURRENT=0

for SYMBOL in $SYMBOLS; do
    CURRENT=$((CURRENT + 1))
    echo ""
    echo "=========================================="
    echo "[$CURRENT/$TOTAL] $SYMBOL @ 1000 dbps"
    echo "=========================================="
    SYMBOL=$SYMBOL THRESHOLD=1000 mise run research:populate-symbol
    echo "Completed $SYMBOL. Sleeping 10s before next..."
    sleep 10
done

echo ""
echo "ALL $TOTAL SYMBOLS @ 1000 dbps COMPLETE"
echo "Finished: $(date)"
"""

["research:status"]
description = "Check population status on littleblack (single check)"
run = "python scripts/monitor_population.py --once --host littleblack"

["research:monitor"]
description = "Start continuous population monitoring (2 min interval)"
run = "python scripts/monitor_population.py --interval 120 --host littleblack"

["research:momentum-analysis"]
description = "Run momentum analysis on all populated symbols"
run = "python scripts/run_length_momentum_multi_symbol.py"

["research:wfo-analysis"]
description = "Run Walk-Forward regime detection"
run = "python scripts/run_length_momentum_wfo.py"
