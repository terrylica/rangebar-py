# ClickHouse Cache Tasks (Issue #84)
# Usage: mise run cache:status
#        mise run cache:populate-all

# =============================================================================
# Database Connectivity
# =============================================================================

["db:ensure"]
description = "Verify bigblack ClickHouse is reachable via SSH"
run = """
ssh -o ConnectTimeout=5 -o BatchMode=yes bigblack \
    'curl -sf http://localhost:8123/ -d "SELECT 1"' > /dev/null 2>&1 \
    && echo "bigblack ClickHouse: OK" \
    || { echo "ERROR: Cannot reach ClickHouse on bigblack. Check SSH config and ClickHouse status." >&2; exit 1; }
"""

# =============================================================================
# Cache Query Tasks
# =============================================================================

["cache:status"]
description = "Show ClickHouse cache statistics"
run = "python scripts/cache_status.py"

["cache:clear"]
description = "Clear ClickHouse cache for a symbol (interactive)"
run = "python scripts/cache_clear.py"

# =============================================================================
# Pueue-Managed Cache Population (Issue #84)
# =============================================================================
# Long-running jobs managed by pueue daemon (survives SSH disconnects).
# Minimum crypto threshold is 250 dbps (enforced by .mise.toml SSoT).
# No per-job env var overrides — mise is the single source of truth.
#
# Phases (4 thresholds: 250, 500, 750, 1000):
#   p1: 1000 dbps (15 jobs, 4 parallel)  — ~8 hrs
#   p2: 250 dbps  (15 jobs, 2 parallel)  — ~24 hrs
#   p3: 500+750   (30 jobs, 3 parallel)  — ~16 hrs

["cache:populate-setup"]
description = "Configure pueue groups for cache population (one-time, idempotent)"
run = "./scripts/pueue-populate.sh setup"

["cache:populate-all"]
description = "Queue all 60 jobs (15 symbols x 4 thresholds) via pueue"
depends = ["cache:populate-setup"]
run = "./scripts/pueue-populate.sh all"

["cache:populate-p1"]
description = "Queue Phase 1: 1000 dbps (15 jobs, 4 parallel)"
depends = ["cache:populate-setup"]
run = "./scripts/pueue-populate.sh phase1"

["cache:populate-p2"]
description = "Queue Phase 2: 250 dbps (15 jobs, 2 parallel)"
depends = ["cache:populate-setup"]
run = "./scripts/pueue-populate.sh phase2"

["cache:populate-p3"]
description = "Queue Phase 3: 500+750 dbps (30 jobs, 3 parallel)"
depends = ["cache:populate-setup"]
run = "./scripts/pueue-populate.sh phase3"

["cache:populate-status"]
description = "Show pueue population progress across all phases"
run = "./scripts/pueue-populate.sh status"

["cache:populate-restart"]
description = "Restart all failed population jobs"
run = "./scripts/pueue-populate.sh restart"

["cache:populate-clean"]
description = "Remove completed jobs from pueue queue"
run = "./scripts/pueue-populate.sh clean"

["cache:populate-guard-status"]
description = "Show resource guard (systemd-run cgroup) status"
run = "./scripts/pueue-populate.sh guard-status"

# =============================================================================
# Autoscaler (dynamic parallelism tuning)
# =============================================================================
# Monitors CPU load + memory, adjusts pueue parallelism per group.
# Complements pueue (which has no resource awareness) with incremental
# scaling protocol from distributed-job-safety skill.

["cache:autoscale"]
description = "Run autoscaler once (dry-run, shows what would change)"
run = "./scripts/pueue-autoscaler.sh"

["cache:autoscale-apply"]
description = "Run autoscaler once and apply parallelism changes"
run = "./scripts/pueue-autoscaler.sh --apply"

["cache:autoscale-loop"]
description = "Start continuous autoscaler (60s interval, Ctrl+C to stop)"
run = "./scripts/pueue-autoscaler.sh --loop"

# =============================================================================
# Issue #88: Volume Overflow Detection & Post-Fix
# =============================================================================

["cache:detect-overflow"]
description = "Detect volume overflow (negative volumes) in ClickHouse cache (Issue #88)"
run = "python scripts/detect_volume_overflow.py"

["cache:postprocess-shib"]
description = "Queue SHIBUSDT force-refresh at all thresholds via pueue (Issue #88 post-fix)"
run = "./scripts/pueue-populate.sh postprocess-shib"

["cache:optimize"]
description = "Run OPTIMIZE TABLE FINAL on range_bars (Issue #88 post-fix)"
run = "./scripts/pueue-populate.sh optimize"

["cache:postprocess-all"]
description = "Full Issue #88 post-fix pipeline via pueue: 4 SHIB jobs → optimize → detect (auto-chained)"
run = "./scripts/pueue-populate.sh postprocess-all"

# =============================================================================
# Issue #90: Dedup Hardening Validation
# =============================================================================

["cache:validate-dedup"]
description = "Validate Issue #90 dedup hardening layers against live ClickHouse"
run = "python scripts/validate_dedup_hardening.py"
