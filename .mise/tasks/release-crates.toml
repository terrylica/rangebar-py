# crates.io Publishing Tasks
# Uses native `cargo publish --workspace` (Rust 1.90+) which auto-discovers
# publishable crates, topologically sorts by dependency order, and pre-validates
# the entire workspace builds before publishing any crate.
# Crates with `publish = false` in their Cargo.toml are automatically skipped.

["release:crates"]
description = "Publish Rust crates to crates.io (native workspace publish)"
depends = ["release:version"]
run = """
#!/usr/bin/env bash
set -euo pipefail

echo "=== Publishing to crates.io ==="

VERSION=$(grep -A5 '\\[workspace.package\\]' Cargo.toml | grep '^version' | head -1 | sed 's/.*= "\\(.*\\)"/\\1/')
echo "Version: $VERSION"

# Get token: 1Password first, file fallback
CARGO_REGISTRY_TOKEN=$(OP_SERVICE_ACCOUNT_TOKEN="$(cat ~/.claude/.secrets/op-service-account-token)" \
  op read "op://Claude Automation/crates-io-token/credential" 2>/dev/null) || \
CARGO_REGISTRY_TOKEN=$(cat ~/.claude/.secrets/crates-io-token 2>/dev/null) || {
  echo "FAIL: No crates.io token found"
  echo "  Option 1: Store in 1Password Claude Automation vault as 'crates-io-token'"
  echo "  Option 2: echo TOKEN > ~/.claude/.secrets/crates-io-token && chmod 600 ~/.claude/.secrets/crates-io-token"
  exit 1
}
export CARGO_REGISTRY_TOKEN

# Native workspace publish (Rust 1.90+):
# - Auto-discovers publishable crates (skips publish=false)
# - Topologically sorts by dependency order
# - Pre-validates entire workspace builds before publishing any crate
cargo publish --workspace

echo ""
echo "OK: Published to crates.io"
"""

["release:crates-dry"]
description = "Dry-run crates.io workspace publish"
run = """
#!/usr/bin/env bash
set -euo pipefail

echo "=== Dry-run crates.io publish ==="
cargo publish --workspace --dry-run
echo "OK: All crates package successfully"
"""
