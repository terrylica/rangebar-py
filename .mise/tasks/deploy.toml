# Deployment Tasks
# Usage: mise run deploy:bigblack
# Keeps remote GPU workstations in sync with releases.

["deploy:bigblack"]
description = "Deploy latest release to bigblack GPU workstation"
depends = ["release:build-all"]
run = """
#!/usr/bin/env bash
set -euo pipefail

echo "=== Deploying to bigblack ==="

REMOTE_HOST="bigblack"
REMOTE_DIR="/home/tca/rangebar-py"
REMOTE_VENV="$REMOTE_DIR/.venv/bin"

# Step 1: Verify SSH connectivity
if ! ssh -o ConnectTimeout=10 -o BatchMode=yes "$REMOTE_HOST" "echo connected" >/dev/null 2>&1; then
    echo "FAIL: Cannot connect to $REMOTE_HOST"
    exit 1
fi
echo "OK: SSH connectivity verified"

# Step 2: Force-sync to origin/main (bigblack is a deploy target, not a dev env)
echo "Syncing to origin/main..."
ssh "$REMOTE_HOST" "cd $REMOTE_DIR && git fetch origin main && git reset --hard origin/main && git clean -fd"
echo "OK: Git sync complete"

# Step 3: Atomic venv rebuild with PyPI CDN readiness poll (Issue #121)
VERSION=$(grep -A5 '\\[workspace.package\\]' Cargo.toml | grep '^version' | head -1 | sed 's/.*= "\\(.*\\)"/\\1/')
if [ -z "$VERSION" ]; then
    echo "FAIL: Could not extract version from Cargo.toml"
    exit 1
fi

# 3a: Wait for PyPI CDN to propagate (max 8 retries, 20s apart = 2.5 min total)
echo "Waiting for rangebar==$VERSION on PyPI CDN..."
PYPI_READY=false
PYPI_MAX_RETRIES=8
for i in $(seq 1 $PYPI_MAX_RETRIES); do
    # Query PyPI JSON API with short timeout (3s, prevents hanging on network issues)
    if ssh "$REMOTE_HOST" "timeout 3 curl -sf 'https://pypi.org/pypi/rangebar/$VERSION/json' 2>/dev/null | jq -e '.info.version' >/dev/null 2>&1"; then
        PYPI_READY=true
        echo "✓ rangebar==$VERSION available on PyPI (attempt $i/$PYPI_MAX_RETRIES)"
        break
    fi
    if [ "$i" -lt "$PYPI_MAX_RETRIES" ]; then
        REMAINING=$((($PYPI_MAX_RETRIES - $i) * 20))
        echo "  ⏳ PyPI CDN not ready yet (attempt $i/$PYPI_MAX_RETRIES, retry in 20s, ~${REMAINING}s remaining)"
        sleep 20
    fi
done
if [ "$PYPI_READY" != "true" ]; then
    echo "⚠ WARNING: rangebar==$VERSION not available on PyPI yet (after $PYPI_MAX_RETRIES retries, ~2.5 min)"
    echo "    Possible causes:"
    echo "    - PyPI upload failed (check release:pypi task logs)"
    echo "    - CDN is slow (unusual, typically propagates within 30s)"
    echo "    - Network issue (SSH tunnel dropped)"
    echo ""
    echo "    Next steps:"
    echo "    1. Check PyPI manually: https://pypi.org/project/rangebar/#history"
    echo "    2. If version exists but not queryable, wait another 2-3 min and retry"
    echo "    3. If version missing, re-run: mise run release:pypi && mise run deploy:bigblack"
    echo ""
    echo "Proceeding anyway (will build venv locally if PyPI unavailable)..."
fi

# 3b: Build in staging venv (old .venv untouched)
# Use mise-managed Python 3.13 (system python may be older)
REMOTE_PYTHON_DIR=$(ssh "$REMOTE_HOST" "mise where python 2>/dev/null || echo ''")
if [ -n "$REMOTE_PYTHON_DIR" ]; then
    REMOTE_PYTHON="$REMOTE_PYTHON_DIR/bin/python3"
else
    # Fallback: find mise-managed Python 3.13 directly
    REMOTE_PYTHON=$(ssh "$REMOTE_HOST" "ls -d ~/.local/share/mise/installs/python/3.13*/bin/python3 2>/dev/null | tail -1 || echo python3")
fi
echo "Building venv in staging area (python=$REMOTE_PYTHON)..."
ssh "$REMOTE_HOST" "cd $REMOTE_DIR && rm -rf .venv-staging && uv venv --python $REMOTE_PYTHON .venv-staging"

INSTALL_OK=false

if [ "$PYPI_READY" = "true" ]; then
    # Install from PyPI (preferred — includes all dependencies)
    # --refresh-package rangebar: force uv to bypass index cache for rangebar
    # Without this, uv's cached index may not include the just-published version
    # even though PyPI JSON API already returns it (uv uses a separate resolver cache)
    if ssh "$REMOTE_HOST" "uv pip install --python $REMOTE_DIR/.venv-staging/bin/python3 --refresh-package rangebar rangebar==$VERSION" 2>&1; then
        INSTALL_OK=true
    else
        echo "⚠ PyPI install failed despite JSON API confirming availability"
        echo "  Falling back to local wheel..."
    fi
fi

if [ "$INSTALL_OK" != "true" ]; then
    # Fallback: SCP local wheel + install from file (Issue #121)
    echo "  Installing from local wheel..."
    LINUX_WHEEL=$(ls dist/rangebar-${VERSION}-*manylinux*.whl 2>/dev/null | head -1)
    if [ -z "$LINUX_WHEEL" ]; then
        echo "FAIL: No local Linux wheel found in dist/ for v$VERSION"
        echo "  Build first: mise run release:build-all"
        ssh "$REMOTE_HOST" "rm -rf $REMOTE_DIR/.venv-staging"
        exit 1
    fi
    scp "$LINUX_WHEEL" "$REMOTE_HOST:$REMOTE_DIR/"
    WHEEL_NAME=$(basename "$LINUX_WHEEL")
    ssh "$REMOTE_HOST" "uv pip install --python $REMOTE_DIR/.venv-staging/bin/python3 $REMOTE_DIR/$WHEEL_NAME && rm -f $REMOTE_DIR/$WHEEL_NAME"
fi

# 3c: Verify staging venv works
STAGING_VERSION=$(ssh "$REMOTE_HOST" "$REMOTE_DIR/.venv-staging/bin/python3 -c 'import rangebar; print(rangebar.__version__)'")
if [ "$STAGING_VERSION" != "$VERSION" ]; then
    echo "FAIL: Staging venv version mismatch ($STAGING_VERSION != $VERSION)"
    ssh "$REMOTE_HOST" "rm -rf $REMOTE_DIR/.venv-staging"
    exit 1
fi

# 3d: Atomic swap (rename is atomic on same filesystem)
ssh "$REMOTE_HOST" "cd $REMOTE_DIR && \
  mv .venv .venv-old 2>/dev/null || true && \
  mv .venv-staging .venv && \
  rm -rf .venv-old"
echo "OK: rangebar $VERSION installed (atomic swap)"

# Step 4: Verify version alignment
REMOTE_VERSION=$(ssh "$REMOTE_HOST" "$REMOTE_VENV/python3 -c 'import rangebar; print(rangebar.__version__)'")
LOCAL_VERSION=$(.venv/bin/python3 -c 'import rangebar; print(rangebar.__version__)' 2>/dev/null || echo "$VERSION")

if [ "$REMOTE_VERSION" = "$LOCAL_VERSION" ]; then
    echo "OK: Version aligned — local=$LOCAL_VERSION, remote=$REMOTE_VERSION"
else
    echo "WARN: Version mismatch — local=$LOCAL_VERSION, remote=$REMOTE_VERSION"
    exit 1
fi

# Step 5: Verify ClickHouse connectivity on bigblack
echo "Verifying ClickHouse connectivity..."
CH_OK=$(ssh "$REMOTE_HOST" "curl -sf 'http://localhost:8123/?query=SELECT+1'" 2>/dev/null || echo "")
if [ "$CH_OK" = "1" ]; then
    echo "OK: ClickHouse responsive"
else
    echo "WARN: ClickHouse not responding (non-fatal)"
fi

# Step 6: Verify symbols.toml is current
echo "Verifying symbols.toml..."
LOCAL_SYMBOLS=$(wc -l < python/rangebar/data/symbols.toml | tr -d ' ')
REMOTE_SYMBOLS=$(ssh "$REMOTE_HOST" "wc -l < $REMOTE_DIR/python/rangebar/data/symbols.toml" | tr -d ' ')
if [ "$LOCAL_SYMBOLS" = "$REMOTE_SYMBOLS" ]; then
    echo "OK: symbols.toml in sync ($LOCAL_SYMBOLS lines)"
else
    echo "WARN: symbols.toml mismatch — local=$LOCAL_SYMBOLS lines, remote=$REMOTE_SYMBOLS lines"
fi

# Step 6b: Sync systemd service files + env files + daemon-reload (Issue #121)
echo "→ Step 6b: Syncing service + env files..."
ssh "$REMOTE_HOST" "mkdir -p ~/.config/systemd/user && \
  cp $REMOTE_DIR/scripts/systemd/rangebar-sidecar.service ~/.config/systemd/user/ && \
  cp $REMOTE_DIR/scripts/systemd/rangebar-kintsugi.service ~/.config/systemd/user/ && \
  cp $REMOTE_DIR/scripts/systemd/rangebar-recency-backfill.service ~/.config/systemd/user/ && \
  systemctl --user daemon-reload && \
  echo 'All 3 service files synced + daemon-reload'"
ssh "$REMOTE_HOST" "systemctl --user enable rangebar-recency-backfill 2>/dev/null || true"

# Step 7: Restart all services (Issue #121)
echo "→ Step 7: Restarting all services..."
SERVICES="rangebar-sidecar rangebar-kintsugi rangebar-recency-backfill"
ALL_HEALTHY=true

for SVC in $SERVICES; do
    ssh "$REMOTE_HOST" "systemctl --user restart $SVC"
done

sleep 5  # Give all services time to initialize

for SVC in $SERVICES; do
    STATUS=$(ssh "$REMOTE_HOST" "systemctl --user is-active $SVC 2>/dev/null || echo 'failed'")
    if [ "$STATUS" = "active" ]; then
        echo "  OK: $SVC running"
    else
        echo "  WARN: $SVC not active (status=$STATUS)"
        echo "  Check: ssh bigblack 'journalctl --user -u $SVC -n 20'"
        ALL_HEALTHY=false
    fi
done

# Sidecar health endpoint
HEALTH=$(ssh "$REMOTE_HOST" "curl -sf http://localhost:8081/health 2>/dev/null | head -c 200 || echo 'unreachable'")
echo "  Sidecar health: $HEALTH"

if [ "$ALL_HEALTHY" != "true" ]; then
    echo ""
    echo "WARN: Some services failed to start — check logs above"
fi

echo ""
echo "OK: bigblack deployment complete (v$REMOTE_VERSION)"
"""

["deploy:bigblack-verify"]
description = "Verify bigblack deployment without changes"
run = """
#!/usr/bin/env bash
set -euo pipefail

echo "=== Verifying bigblack deployment ==="

REMOTE_HOST="bigblack"
REMOTE_DIR="/home/tca/rangebar-py"
REMOTE_VENV="$REMOTE_DIR/.venv/bin"

# SSH check
if ! ssh -o ConnectTimeout=10 -o BatchMode=yes "$REMOTE_HOST" "echo connected" >/dev/null 2>&1; then
    echo "FAIL: Cannot connect to $REMOTE_HOST"
    exit 1
fi

# Version
REMOTE_VERSION=$(ssh "$REMOTE_HOST" "$REMOTE_VENV/python3 -c 'import rangebar; print(rangebar.__version__)'" 2>/dev/null || echo "N/A")
LOCAL_VERSION=$(.venv/bin/python3 -c 'import rangebar; print(rangebar.__version__)' 2>/dev/null || echo "N/A")
echo "rangebar: local=$LOCAL_VERSION remote=$REMOTE_VERSION"

# Git status
REMOTE_BRANCH=$(ssh "$REMOTE_HOST" "cd $REMOTE_DIR && git rev-parse --short HEAD")
LOCAL_BRANCH=$(git rev-parse --short HEAD)
echo "git HEAD: local=$LOCAL_BRANCH remote=$REMOTE_BRANCH"
REMOTE_DIRTY=$(ssh "$REMOTE_HOST" "cd $REMOTE_DIR && git status --porcelain" 2>/dev/null || echo "")
if [ -n "$REMOTE_DIRTY" ]; then
    echo "git clean: NO (untracked/modified files present)"
else
    echo "git clean: YES"
fi

# ClickHouse
CH_OK=$(ssh "$REMOTE_HOST" "curl -sf 'http://localhost:8123/?query=SELECT+1'" 2>/dev/null || echo "")
if [ "$CH_OK" = "1" ]; then
    echo "ClickHouse: OK"
else
    echo "ClickHouse: NOT RESPONDING"
fi

# symbols.toml
LOCAL_SYMBOLS=$(wc -l < python/rangebar/data/symbols.toml | tr -d ' ')
REMOTE_SYMBOLS=$(ssh "$REMOTE_HOST" "wc -l < $REMOTE_DIR/python/rangebar/data/symbols.toml" | tr -d ' ')
echo "symbols.toml: local=$LOCAL_SYMBOLS lines remote=$REMOTE_SYMBOLS lines"

# Service status (Issue #121)
echo "→ Service status..."
for SVC in rangebar-sidecar rangebar-kintsugi rangebar-recency-backfill; do
    STATUS=$(ssh "$REMOTE_HOST" "systemctl --user is-active $SVC 2>/dev/null || echo 'not running'")
    echo "  $SVC: $STATUS"
done
HEALTH=$(ssh "$REMOTE_HOST" "curl -sf http://localhost:8081/health 2>/dev/null | head -c 200 || echo 'unreachable'")
echo "  Sidecar health: $HEALTH"

# Verdict
if [ "$REMOTE_VERSION" = "$LOCAL_VERSION" ] && [ "$REMOTE_BRANCH" = "$LOCAL_BRANCH" ]; then
    echo ""
    echo "OK: bigblack is in sync"
else
    echo ""
    echo "WARN: bigblack is out of sync — run: mise run deploy:bigblack"
    exit 1
fi
"""
